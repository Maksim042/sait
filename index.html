<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</title>

  <style>
    :root {
      --primary: #14b8a6;
      --primary-dark: #0d9488;
      --light: #f8fffe;
      --gray: #64748b;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      margin: 0;
      padding: 20px 20px 40px;
      color: #1e293b;
      min-height: 100vh;
    }

    .auth-bar {
      background: white;
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(20,184,166,0.1);
      margin: 0 auto 24px;
      max-width: 420px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      color: #0f766e;
    }

    .user-email {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
    }

    .form-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(20, 184, 166, 0.12);
      width: 100%;
      max-width: 420px;
      border: 1px solid #d1f0e8;
      margin: 0 auto 24px;
      display: none;
    }

    .login-prompt {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 16px;
      max-width: 420px;
      margin: 0 auto 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }

    h3 { text-align: center; margin: 0 0 8px; color: #0f766e; font-size: 1.7rem; font-weight: 600; }
    .subtitle { text-align: center; color: var(--gray); margin: 0 0 28px; font-size: 0.95rem; }

    label { display: block; margin-bottom: 6px; color: #334155; font-weight: 500; font-size: 0.95rem; }
    input {
      width: 100%;
      padding: 13px 15px;
      margin-bottom: 18px;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      font-size: 1rem;
      background: var(--light);
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(20,184,166,0.15);
    }
    input[readonly] { background: #f1f5f9; color: #475569; }

    button {
      width: 100%;
      padding: 13px;
      background: var(--primary);
      border: none;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s;
    }
    button:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    button:disabled { background: #94a3b8; cursor: not-allowed; }

    .counter { text-align: center; font-size: 1.1rem; color: #0f766e; margin: 16px 0; font-weight: 600; }

    .feed { width: 100%; max-width: 420px; margin: 0 auto; }
    .post {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .name { font-weight: 600; color: #0f766e; font-size: 1.05rem; }
    .time { font-size: 0.78rem; color: var(--gray); margin-left: auto; }
    .email { color: #475569; font-size: 0.92rem; margin: 4px 0 12px; word-break: break-all; }

    .like-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f0fdfa;
      color: #0f766e;
      border: 1px solid #99f6e4;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .like-btn:hover { background: #ccfbf1; border-color: #5eead4; }

    .footer-heart { text-align: center; margin-top: 32px; font-size: 1.6rem; color: var(--primary); opacity: 0.7; }
  </style>
</head>
<body>

  <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="auth-bar">
    <button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>

    <div id="userInfo" style="display:none; flex:1; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <img id="userPhoto" class="user-avatar" src="" alt="" style="display:none;">
      <div class="user-info">
        <div class="user-name" id="userName"></div>
        <div class="user-email" id="userEmail"></div>
      </div>
      <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
  <div id="formContainer" class="form-container">
    <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</h3>
    <div class="subtitle">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è üíô</div>
    <form id="feedbackForm">
      <label for="userName">–ò–º—è</label>
      <input type="text" id="userName" readonly>

      <label for="userEmail">Email</label>
      <input type="email" id="userEmail" readonly>

      <button type="submit" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </div>

  <div style="width:100%; max-width:420px; margin:0 auto 16px; display:none;" id="searchWrapper">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
  </div>

  <div class="counter" id="counterBlock" style="display:none;">
    –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: <span id="totalCount">‚Äî</span>
  </div>

  <div class="feed" id="feed"></div>

  <div class="footer-heart">üíô</div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot,
      doc, updateDoc, serverTimestamp, increment, getCountFromServer
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGJvVV91pvYw4nzxAyvvnk8tVuMVHYIj8",
      authDomain: "maxim42-42e00.firebaseapp.com",
      projectId: "maxim42-42e00",
      storageBucket: "maxim42-42e00.firebasestorage.app",
      messagingSenderId: "358434279205",
      appId: "1:358434279205:web:97a2f74378e319d83514cc",
      measurementId: "G-LL6KD44CES"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let allRequests = [];

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const loginBtn      = document.getElementById('loginBtn');
    const logoutBtn     = document.getElementById('logoutBtn');
    const userInfo      = document.getElementById('userInfo');
    const userPhoto     = document.getElementById('userPhoto');
    const userNameEl    = document.getElementById('userName');
    const userEmailEl   = document.getElementById('userEmail');
    const formContainer = document.getElementById('formContainer');
    const searchWrapper = document.getElementById('searchWrapper');
    const counterBlock  = document.getElementById('counterBlock');
    const nameInput     = document.getElementById('userName');
    const emailInput    = document.getElementById('userEmail');
    const submitBtn     = document.getElementById('submitBtn');
    const form          = document.getElementById('feedbackForm');

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    loginBtn.onclick = () => signInWithPopup(auth, provider).catch(console.error);
    logoutBtn.onclick = () => signOut(auth).catch(console.error);

    onAuthStateChanged(auth, user => {
      if (user) {
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        formContainer.style.display = 'block';
        searchWrapper.style.display = 'block';
        counterBlock.style.display = 'block';

        userPhoto.src = user.photoURL || 'https://via.placeholder.com/44';
        userPhoto.style.display = user.photoURL ? 'block' : 'block';
        userNameEl.textContent = user.displayName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        userEmailEl.textContent = user.email || '';

        nameInput.value = user.displayName || '';
        emailInput.value = user.email || '';
      } else {
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
        formContainer.style.display = 'none';
        searchWrapper.style.display = 'none';
        counterBlock.style.display = 'none';
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener("submit", async e => {
      e.preventDefault();
      if (!auth.currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();

      if (!name || !email) return alert("–ó–∞–ø–æ–ª–Ω–µ–Ω—ã –Ω–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ");

      submitBtn.disabled = true;
      submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...";

      try {
        await addDoc(collection(db, "requests"), {
          name,
          name_lower: name.toLowerCase().trim(),
          email,
          photo: auth.currentUser.photoURL || null,
          likes: 0,
          timestamp: serverTimestamp(),
          createdAt: new Date().toISOString(),
          approved: false,
          uid: auth.currentUser.uid   // –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤/–ø—Ä–∞–≤–∏–ª
        });
        alert("–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ üíô");
        form.reset();
      } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      }
    });

    // –õ–∞–π–∫
    window.addLike = async id => {
      try {
        await updateDoc(doc(db, "requests", id), { likes: increment(1) });
      } catch (err) {
        console.error("–õ–∞–π–∫ –Ω–µ —É–¥–∞–ª—Å—è", err);
      }
    };

    // –°—á—ë—Ç—á–∏–∫
    async function updateTotalCount() {
      try {
        const snap = await getCountFromServer(collection(db, "requests"));
        document.getElementById("totalCount").textContent = snap.data().count;
      } catch (e) {
        document.getElementById("totalCount").textContent = "‚Äî";
      }
    }

    // –õ–µ–Ω—Ç–∞ + –ø–æ–∏—Å–∫
    const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));

    onSnapshot(q, snapshot => {
      allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderFeed();
      updateTotalCount();
    });

    function renderFeed() {
      const feed = document.getElementById("feed");
      const term = document.getElementById("searchInput")?.value?.trim().toLowerCase() || "";

      feed.innerHTML = "";

      const filtered = allRequests.filter(item =>
        !term || (item.name || "").toLowerCase().includes(term)
      );

      if (filtered.length === 0) {
        feed.innerHTML = '<p style="text-align:center; color:var(--gray); padding:60px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      filtered.forEach(data => {
        const time = data.timestamp
          ? new Date(data.timestamp.toDate()).toLocaleString("ru-RU", {
              day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit"
            })
          : "‚Ä¶";

        const post = document.createElement("div");
        post.className = "post";
        post.innerHTML = `
          <div class="post-header">
            <img src="${data.photo || 'https://via.placeholder.com/40'}" class="user-avatar" alt="">
            <span class="name">${data.name || "‚Äî"}</span>
            <span class="time">${time}</span>
          </div>
          <div class="email">${data.email || "‚Äî"}</div>
          <button class="like-btn" onclick="addLike('${data.id}')">
            üíô ${data.likes || 0}
          </button>
        `;
        feed.appendChild(post);
      });
    }

    document.getElementById("searchInput")?.addEventListener("input", renderFeed);
    updateTotalCount();
  </script>
</body>
</html>
