<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ë–∞–∑–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f4f7f8; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }

    .auth-bar { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #007bff; }

    input[type="text"], input[type="email"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-weight: 600; cursor: pointer; transition: 0.3s; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .logout-btn { background: #ff4757; padding: 8px 15px; width: auto; font-size: 14px; }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      margin: 10px 0;
      position: relative;
      color: #888;
    }
    .upload-area:hover { border-color: #007bff; color: #007bff; background: #f0f6ff; }
    .upload-area.has-image { border-color: #28a745; color: #28a745; }
    .upload-area input[type="file"] { display: none; }
    .upload-area .upload-icon { font-size: 32px; margin-bottom: 6px; }
    .upload-area .upload-text { font-size: 14px; }

    #imagePreview {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }

    .progress-bar-wrap {
      width: 100%;
      background: #eee;
      border-radius: 10px;
      height: 8px;
      margin: 8px 0;
      display: none;
    }
    .progress-bar {
      height: 8px;
      background: #007bff;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }

    /* –õ–µ–Ω—Ç–∞ */
    .post { background: #fff; border: 1px solid #eaeaea; padding: 15px; margin-top: 15px; border-radius: 8px; width: 100%; max-width: 500px; box-sizing: border-box; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .post-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    .like-btn { cursor: pointer; border: none; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; margin-top: 10px; font-size: 14px; transition: 0.2s; }
    .like-btn:hover { background: #ffe0e0; }
    .time { font-size: 11px; color: #999; margin-left: auto; }
    .post-image { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin: 10px 0; display: block; }
    .post-text { margin: 6px 0; color: #333; }
  </style>
</head>
<body>

  <div id="authSection" class="container" style="max-width: 500px; text-align: center;">
    <button id="loginBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <div id="userInfo" style="display: none;" class="auth-bar">
      <img id="userPhoto" class="user-avatar" src="" alt="Avatar">
      <span id="userName" style="font-weight: bold;"></span>
      <button id="logoutBtn" class="logout-btn">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div id="messageForm" class="container" style="display: none;">
    <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
    <input type="text" id="name" placeholder="–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å" readonly>
    <input type="email" id="email" placeholder="–í–∞—à email" readonly>
    <input type="text" id="content" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?">

    <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
      <div class="upload-icon">üñºÔ∏è</div>
      <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
      <input type="file" id="imageInput" accept="image/*">
    </div>
    <img id="imagePreview" alt="Preview">

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="progress-bar-wrap" id="progressWrap">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="uploadStatus" style="font-size:13px; color:#888; margin-bottom:6px;"></div>

    <button id="mainBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
  </div>

  <div id="feed" style="width: 100%; max-width: 500px;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, increment, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGJvVV91pvYw4nzxAyvvnk8tVuMVHYIj8",
    authDomain: "maxim42-42e00.firebaseapp.com",
    projectId: "maxim42-42e00",
    storageBucket: "maxim42-42e00.firebasestorage.app",
    messagingSenderId: "358434279205",
    appId: "1:358434279205:web:97a2f74378e319d83514cc",
    measurementId: "G-LL6KD44CES"
  };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const messageForm = document.getElementById('messageForm');

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        messageForm.style.display = 'block';
        document.getElementById('userName').innerText = user.displayName;
        document.getElementById('userPhoto').src = user.photoURL;
        document.getElementById('name').value = user.displayName;
        document.getElementById('email').value = user.email;
      } else {
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
        messageForm.style.display = 'none';
      }
    });

    // --- –ü–†–ï–í–¨–Æ –ö–ê–†–¢–ò–ù–ö–ò ---
    let selectedFile = null;

    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞ (–º–∞–∫—Å 5 –ú–ë)
      if (!file.type.startsWith('image/')) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë.");
        return;
      }

      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const preview = document.getElementById('imagePreview');
        preview.src = ev.target.result;
        preview.style.display = 'block';
        const area = document.getElementById('uploadArea');
        area.classList.add('has-image');
        area.querySelector('.upload-text').textContent = file.name;
        area.querySelector('.upload-icon').textContent = '‚úÖ';
      };
      reader.readAsDataURL(file);
    });

    // --- –ó–ê–ì–†–£–ó–ö–ê –ö–ê–†–¢–ò–ù–ö–ò –í STORAGE ---
    function uploadImage(file) {
      return new Promise((resolve, reject) => {
        const storageRef = ref(storage, `images/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);

        const progressWrap = document.getElementById('progressWrap');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');

        progressWrap.style.display = 'block';
        uploadStatus.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...';

        uploadTask.on('state_changed',
          (snapshot) => {
            const percent = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
            progressBar.style.width = percent + '%';
            uploadStatus.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${percent}%`;
          },
          (error) => {
            uploadStatus.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            reject(error);
          },
          async () => {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            progressWrap.style.display = 'none';
            uploadStatus.textContent = '‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!';
            resolve(url);
          }
        );
      });
    }

    // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø ---
    document.getElementById('mainBtn').onclick = async () => {
      const content = document.getElementById('content').value;
      if (!content && !selectedFile) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ.");

      const btn = document.getElementById('mainBtn');
      btn.disabled = true;
      btn.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';

      try {
        let imageUrl = null;

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–Ω–∞—á–∞–ª–∞
        if (selectedFile) {
          imageUrl = await uploadImage(selectedFile);
        }

        await addDoc(collection(db, "requests"), {
          name: auth.currentUser.displayName,
          email: auth.currentUser.email,
          photo: auth.currentUser.photoURL,
          text: content,
          imageUrl: imageUrl || null,
          likes: 0,
          timestamp: serverTimestamp()
        });

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        document.getElementById('content').value = "";
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageInput').value = "";
        document.getElementById('uploadStatus').textContent = '';
        const area = document.getElementById('uploadArea');
        area.classList.remove('has-image');
        area.querySelector('.upload-text').textContent = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ';
        area.querySelector('.upload-icon').textContent = 'üñºÔ∏è';
        selectedFile = null;

      } catch (e) {
        alert("–û—à–∏–±–∫–∞: " + e.message);
      }

      btn.disabled = false;
      btn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ';
    };

    // --- –õ–ê–ô–ö–ò ---
    window.processLike = async (id) => {
      await updateDoc(doc(db, "requests", id), { likes: increment(1) });
    };

    // --- REAL-TIME –õ–ï–ù–¢–ê ---
    const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        feed.innerHTML += `
          <div class="post">
            <div class="post-header">
              <img src="${data.photo || 'https://via.placeholder.com/30'}" class="post-avatar">
              <b>${data.name}</b>
              <span class="time">${data.timestamp?.toDate().toLocaleTimeString() || '...'}</span>
            </div>
            ${data.imageUrl ? `<img src="${data.imageUrl}" class="post-image" alt="–§–æ—Ç–æ">` : ''}
            ${data.text ? `<p class="post-text">${data.text}</p>` : ''}
            <button class="like-btn" onclick="processLike('${docSnap.id}')">üëç ${data.likes || 0}</button>
          </div>
        `;
      });
    });

    window.db = db;
  </script>
</body>
</html>
